{% extends "master.html" %}

{% block title %}NIC TG - Employees Form{% endblock %}

{% block content %}

<div class="container mt-4 mb-5">

  <!-- ================= FORM PAGE ================= -->
  <div id="formPage">

    <h3 class="mb-3">Employee Form</h3>

    <form id="employeeForm">
      {% csrf_token %}

      <table class="table table-borderless">
        {{ form.as_table }}
      </table>

      <button type="submit" class="btn btn-warning">
        Save as Draft
      </button>

      <button type="button"
              class="btn btn-outline-primary ms-2"
              onclick="showDraftsPage()">
        Show Drafts
      </button>

      <small class="text-muted ms-2">
        Drafts are saved until final submission.
      </small>
    </form>

  </div>

  <!-- ================= DRAFTS PAGE ================= -->
  <div id="draftsPage" style="display:none;">

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>Drafts</h3>
      <button class="btn btn-secondary" onclick="showFormPage()">
        ← Back to Form
      </button>
    </div>

    <input type="text"
           id="draftSearch"
           class="form-control mb-3"
           placeholder="Search drafts..."
           onkeyup="filterDrafts()">

    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Select</th>
          <th>Empcode</th>
          <th>Name</th>
          <th>Designation</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="draftTableBody"></tbody>
    </table>

    <button class="btn btn-success" onclick="submitSelectedDrafts()">
      Submit Selected
    </button>

    <button class="btn btn-outline-secondary ms-2"
            onclick="showSubmittedPage()">
      Submitted Records
    </button>

  </div>

  <!-- ================= SUBMITTED RECORDS PAGE ================= -->
  <div id="submittedPage" style="display:none;">

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>Submitted Records</h3>
      <button class="btn btn-secondary" onclick="showDraftsPage()">
        ← Back to Drafts
      </button>
    </div>

    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Empcode</th>
          <th>Name</th>
          <th>Hindi Name</th>
          <th>Designation</th>
          <th>Gazet</th>
          <th>Prabodh</th>
          <th>Praveen</th>
          <th>Pragya</th>
          <th>Parangat</th>
          <th>Typing</th>
          <th>Hindi Proficiency</th>
        </tr>
      </thead>
      <tbody id="submittedTableBody"></tbody>
    </table>

  </div>

</div>

<!-- ================= SCRIPT ================= -->
<script>
let editingDraftId = null;
let allDrafts = [];

/* ================= SAVE AS DRAFT ================= */
document.getElementById("employeeForm").addEventListener("submit", function (e) {
  e.preventDefault();

  const formData = new FormData(e.target);
  let jsonData = {};

  formData.forEach((value, key) => {
    jsonData[key] = value;
  });

  jsonData["status"] = "draft";

  const url = editingDraftId
    ? `/api/employees/${editingDraftId}/`
    : "/api/employees/";

  const method = editingDraftId ? "PUT" : "POST";

  fetch(url, {
    method: method,
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCookie("csrftoken")
    },
    body: JSON.stringify(jsonData)
  })
  .then(res => res.json())
  .then(() => {
    alert("✅ Draft saved successfully");
    editingDraftId = null;
    e.target.reset();
  })
  .catch(() => alert("Network error"));
});

/* ================= PAGE SWITCHING ================= */
function showDraftsPage() {
  hideAllPages();
  document.getElementById("draftsPage").style.display = "block";
  loadDrafts();
}

function showFormPage() {
  hideAllPages();
  document.getElementById("formPage").style.display = "block";
}

function showSubmittedPage() {
  hideAllPages();
  document.getElementById("submittedPage").style.display = "block";
  loadSubmittedRecords();
}

function hideAllPages() {
  document.getElementById("formPage").style.display = "none";
  document.getElementById("draftsPage").style.display = "none";
  document.getElementById("submittedPage").style.display = "none";
}

/* ================= LOAD DRAFTS ================= */
function loadDrafts() {
  fetch("/api/employees/?status=draft")
    .then(res => res.json())
    .then(data => {
      allDrafts = data;
      renderDraftTable(data);
    });
}

/* ================= RENDER DRAFT TABLE ================= */
function renderDraftTable(data) {
  const tbody = document.getElementById("draftTableBody");
  tbody.innerHTML = "";

  data.forEach(d => {
    tbody.innerHTML += `
      <tr>
        <td><input type="checkbox" value="${d.id}"></td>
        <td>${d.empcode}</td>
        <td>${d.ename}</td>
        <td>${d.designation}</td>
        <td>
          <button class="btn btn-sm btn-primary"
                  onclick="editDraft(${d.id})">Edit</button>
          <button class="btn btn-sm btn-danger"
                  onclick="deleteDraft(${d.id})">Delete</button>
        </td>
      </tr>
    `;
  });
}

/* ================= SEARCH ================= */
function filterDrafts() {
  const q = document.getElementById("draftSearch").value.toLowerCase();
  renderDraftTable(
    allDrafts.filter(d =>
      d.ename.toLowerCase().includes(q) ||
      d.empcode.toString().includes(q)
    )
  );
}

/* ================= EDIT DRAFT ================= */
function editDraft(id) {
  fetch(`/api/employees/${id}/`)
    .then(res => res.json())
    .then(data => {
      editingDraftId = id;
      for (let key in data) {
        const field = document.querySelector(`[name="${key}"]`);
        if (field) field.value = data[key];
      }
      showFormPage();
      window.scrollTo({ top: 0, behavior: "smooth" });
    });
}

/* ================= DELETE DRAFT ================= */
function deleteDraft(id) {
  if (!confirm("Delete this draft?")) return;

  fetch(`/api/employees/${id}/`, {
    method: "DELETE",
    headers: { "X-CSRFToken": getCookie("csrftoken") }
  }).then(loadDrafts);
}

/* ================= BULK SUBMIT ================= */
function submitSelectedDrafts() {
  const checked = document.querySelectorAll(
    "#draftTableBody input[type='checkbox']:checked"
  );

  if (checked.length === 0) {
    alert("Please select at least one draft");
    return;
  }

  const ids = Array.from(checked).map(cb => cb.value);

  fetch("/api/employees/submit/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCookie("csrftoken")
    },
    body: JSON.stringify({ ids })
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);
    loadDrafts();
  });
}

/* ================= SUBMITTED RECORDS ================= */
function loadSubmittedRecords() {
  fetch("/api/employees/?status=submitted")
    .then(res => res.json())
    .then(data => {
      const tbody = document.getElementById("submittedTableBody");
      tbody.innerHTML = "";

      data.forEach(d => {
        tbody.innerHTML += `
          <tr>
            <td>${d.empcode}</td>
            <td>${d.ename}</td>
            <td>${d.hname}</td>
            <td>${d.designation}</td>
            <td>${d.gazet}</td>
            <td>${d.prabodh}</td>
            <td>${d.praveen}</td>
            <td>${d.pragya}</td>
            <td>${d.parangat}</td>
            <td>${d.typing}</td>
            <td>${d.hindiproficiency}</td>
          </tr>
        `;
      });
    });
}

/* ================= CSRF HELPER ================= */
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie) {
    document.cookie.split(';').forEach(cookie => {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
      }
    });
  }
  return cookieValue;
}
</script>

{% endblock %}

